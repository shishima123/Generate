<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Tool Generate Batch</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.js"></script>
  <script>
    var ExcelToJSON = function () {
      this.parseExcel = function (file) {
        var reader = new FileReader();

        reader.onload = function (e) {
          var data = e.target.result;
          var workbook = XLSX.read(data, {
            type: "binary"
          });
          var worksheet = workbook.Sheets[workbook.SheetNames[0]];
          // Here is your object
          var sheetMapping = XLSX.utils.sheet_to_row_object_array(
            workbook.Sheets[workbook.SheetNames[0]]
          );

          var namePKG = $('#namePKG').val();
          var nameJapanOfPkg = $('#nameJapanOfPkg').val();

          var mappingToJson = JSON.stringify(sheetMapping);
          var parse_json_mapping = JSON.parse(mappingToJson);
          var json_table_WK = TableWKToJson(workbook);
          var json_table_T_REL = TableT_RELToJson(workbook);

          var namePhysicTableT_REL = Object.keys(parse_json_mapping[0])[0]; // ten vat ly cua bang t_rel
          var namePhysicTableWK = Object.keys(parse_json_mapping[0])[3]; // ten vat ly cua bang WK
          console.log(parse_json_mapping)

          // Chon loai Batch se duoc gen
          var type = $( "#typeBatch option:selected" ).val();

          switch(type) {
            case "HD_DT_TR":
              var startToCompare = Start_To_Compare_Common(namePKG, nameJapanOfPkg ,namePhysicTableT_REL ,namePhysicTableWK);
              var compareToDeclare = Compare_To_Declare_HD_DT_TR();
              var declareToSubStrb = Declare_To_SubStrb_HD_DT_TR(json_table_WK);
              var subStrbToInsertWK = SubStrb_To_Insert_WK_HD_DT_TR(json_table_WK);
              var insertWKToInsertTREL = Insert_WK_To_Insert_T_REL_HD_DT_TR(json_table_WK, namePhysicTableWK);
              var insertT_RELToEnd = Insert_T_REL_To_End_Common(parse_json_mapping, json_table_T_REL, namePhysicTableT_REL, namePhysicTableWK, namePKG);
              var output = startToCompare + compareToDeclare + declareToSubStrb + subStrbToInsertWK + insertWKToInsertTREL + insertT_RELToEnd;

              break;
            case "HD_DT":
              var startToCompare = Start_To_Compare_Common(namePKG, nameJapanOfPkg ,namePhysicTableT_REL ,namePhysicTableWK);
              var compareToSubStrb = Compare_To_SubStrb_HD_DT();
              var subStrbToInsertWK = SubStrb_To_Insert_WK_HD_DT(json_table_WK);
              var insertWKToInsertT_REL = Insert_WK_To_Insert_T_REL_HD_DT(json_table_WK, namePhysicTableWK);
              var insertT_RELToEnd = Insert_T_REL_To_End_Common(parse_json_mapping, json_table_T_REL, namePhysicTableT_REL, namePhysicTableWK, namePKG);
              var output = startToCompare + compareToSubStrb + subStrbToInsertWK + insertWKToInsertT_REL + insertT_RELToEnd;

              break;
            default:
            console.log('a')
            }
          
          $("#xlx_json").val(output);
        };

        reader.onerror = function (ex) {
          console.log(ex);
        };

        reader.readAsBinaryString(file);
      };
    };

    function handleFileSelect(evt) {
      var files = evt.target.files; // FileList object
      var xl2json = new ExcelToJSON();
      xl2json.parseExcel(files[0]);
    }
  </script>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-12">
        <form enctype="multipart/form-data" class="my-3">
          <input id="upload" type="file" name="files[]" />
        </form>
      </div>
    </div>
    <div class="row">
      <div class="col-8">
        <textarea class="form-control" rows="35" cols="120" id="xlx_json"></textarea>
      </div>
      <div class="col-4">
        <div>
          Tên Package : <input id="namePKG" type="text">
        </div>
        <div>
          Tên Package(Japan): <input id="nameJapanOfPkg" type="text">
        </div>
        <label class="mt-5">Điều Kiện Where Đặc Biệt</label>
        <textarea class="form-control" rows="2" cols="8" id="whereExtend"></textarea>
        <div class="form-group mt-5">
          <label for="typeBatch">Type Batch</label>
          <select class="form-control" id="typeBatch">
            <option value="HD_DT_TR">HD_DT_TR</option>
            <option value="HD_DT">HD_DT</option>
            <option>3</option>
            <option>4</option>
            <option>5</option>
          </select>
        </div>
      </div>
    </div>

  </div>
  </div>

  <script>
    document
      .getElementById("upload")
      .addEventListener("change", handleFileSelect, false);
  </script>
  <script src="./core.js"></script>
  <script src="./HD_DT_TR.js"></script>
  <script src="./HD_DT.js"></script>
  <script src="./common.js"></script>
</body>

</html>